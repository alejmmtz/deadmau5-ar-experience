<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>&lt;model-viewer&gt; — Responsive & Perfecto</title>

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg-900: #000000;
        --bg-800: #0b0b0b;
        --glass: rgba(255, 255, 255, 0.03);
        --glass-2: rgba(255, 255, 255, 0.02);
        --accent: #e53935; /* red */
        --accent-2: #b71c1c; /* dark red */
        --white: #ffffff;
        --muted: rgba(255, 255, 255, 0.78);
        --muted-2: rgba(255, 255, 255, 0.6);
        --soft-shadow: 0 18px 50px rgba(0, 0, 0, 0.75);
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial;
        color: var(--muted);
        background: linear-gradient(180deg, var(--bg-900), var(--bg-800));
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* page layout */
      .wrap {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 28px;
      }

      /* main card */
      .card {
        width: min(1200px, 98vw);
        border-radius: 16px;
        padding: 18px;
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 20px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.01),
          rgba(255, 255, 255, 0.005)
        );
        box-shadow: var(--soft-shadow);
        backdrop-filter: blur(6px);
      }

      /* viewer column */
      .viewer-wrap {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        padding: 10px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.01),
          rgba(255, 255, 255, 0.005)
        );
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .viewer-frame {
        width: 100%;
        height: 100%;
        display: block;
        border-radius: 10px;
        overflow: hidden;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0.3),
          rgba(0, 0, 0, 0.12)
        );
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.02);
      }

      model-viewer {
        width: 100%;
        height: 100%;
        display: block;
        border-radius: 10px;
        aspect-ratio: 16/10;
        background: #080808;
      }

      /* desktop hover effect: lift the viewer slightly */
      @media (hover: hover) {
        .viewer-wrap:hover {
          transform: translateY(-6px);
          transition: transform 0.24s cubic-bezier(0.2, 0.9, 0.3, 1);
        }
      }

      /* right panel */
      .panel {
        padding: 18px;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.01),
          rgba(255, 255, 255, 0.005)
        );
        min-height: 260px;
      }
      .title {
        font-size: 20px;
        color: var(--white);
        margin: 0;
        font-weight: 700;
      }
      .desc {
        font-size: 13px;
        color: var(--muted-2);
        margin: 0;
      }

      .meta {
        display: flex;
        gap: 12px;
        margin-top: 6px;
        flex-wrap: wrap;
      }
      .meta .box {
        flex: 1;
        padding: 10px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.02);
        font-size: 13px;
      }
      .meta .val {
        color: var(--white);
        font-weight: 700;
        margin-top: 6px;
      }

      /* controls */
      .controls {
        display: flex;
        gap: 8px;
        margin-top: auto;
      }
      .btn {
        border: 0;
        padding: 10px;
        border-radius: 10px;
        background: transparent;
        color: var(--muted);
        cursor: pointer;
        display: inline-grid;
        place-items: center;
        box-shadow: 0 6px 18px rgba(2, 6, 23, 0.5);
        transition: transform 0.14s ease;
      }
      .btn:hover {
        transform: translateY(-3px);
      }
      .btn.primary {
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: white;
        padding: 10px 14px;
      }

      /* floating HUD (top-right) */
      .hud {
        position: absolute;
        right: 12px;
        top: 12px;
        display: flex;
        gap: 8px;
        align-items: center;
        z-index: 6;
      }
      .hud .circle {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        display: inline-grid;
        place-items: center;
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(4px);
      }

      .overlay-play {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        z-index: 8;
        display: none;
      }
      .overlay-play button {
        padding: 12px 18px;
        border-radius: 999px;
        font-weight: 700;
        border: 0;
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        color: white;
        box-shadow: 0 12px 30px rgba(2, 6, 23, 0.6);
      }

      /* mobile */
      @media (max-width: 980px) {
        .card {
          grid-template-columns: 1fr;
          gap: 12px;
          padding: 14px;
        }
        model-viewer {
          aspect-ratio: 4/3;
        }
        .panel {
          order: 2;
        }
        .viewer-wrap {
          order: 1;
          padding: 12px;
        }
        .hud {
          top: 10px;
          right: 10px;
        }
        .overlay-play {
          display: none;
        }
      }

      @media (max-width: 520px) {
        .card {
          padding: 10px;
          border-radius: 12px;
        }
        .panel {
          position: relative;
          padding: 14px;
          border-radius: 12px;
        }
        .overlay-play {
          display: block;
        }
        .hud {
          right: 8px;
          top: 8px;
        }
        .meta {
          flex-direction: column;
        }
      }

      .hint {
        font-size: 12px;
        color: var(--muted-2);
      }
      .small {
        font-size: 13px;
      }
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      model-viewer::part(ar-button) {
        border-radius: 12px;
        padding: 10px 12px;
        font-weight: 700;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <main class="card" role="main">
        <section class="viewer-wrap" aria-label="Visor 3D">
          <!-- overlay play for mobile (initially hidden; JS toggles) -->
          <div class="overlay-play" id="overlayPlay">
            <button
              id="overlayPlayBtn"
              aria-label="Reproducir audio y activar escena"
            >
              Reproducir
            </button>
          </div>

          <!-- floating HUD (mute & AR quick) -->
          <div class="hud" aria-hidden="false">
            <div class="circle" id="arQuick" title="Abrir en AR">
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                aria-hidden
              >
                <path
                  d="M12 2v4"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M12 18v4"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M4 12h4"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M16 12h4"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </div>

            <button
              class="circle"
              id="muteToggle"
              aria-pressed="false"
              aria-label="activar sonido"
            >
              <svg
                id="muteSvg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
              >
                <path
                  d="M5 9v6h4l5 4V5L9 9H5z"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  id="x"
                  d="M17 7l4 4m0-4l-4 4"
                  stroke="currentColor"
                  stroke-width="1.6"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  opacity="0.9"
                />
              </svg>
            </button>
          </div>

          <!-- audio (hidden but playable). playsinline for iOS; webkitPlaysInline set via JS for safety -->
          <audio id="bgAudio" preload="auto" loop playsinline>
            <source src="./maths.mp3" type="audio/mpeg" />
            Tu navegador no soporta audio en línea.
          </audio>

          <div class="viewer-frame" id="viewerFrame">
            <model-viewer
              id="mv"
              src="stage5.glb"
              poster="poster.webp"
              ar
              ar-modes="webxr scene-viewer quick-look"
              camera-controls
              interaction-prompt="auto"
              shadow-intensity="0.95"
              shadow-softness="0.44"
              exposure="1.51"
              autoplay
              camera-orbit="-270.3deg 87.17deg 258.5m"
              field-of-view="30deg"
            >
              <button slot="ar-button" id="ar-button">Ver en tu espacio</button>
            </model-viewer>
          </div>
        </section>

        <aside class="panel" aria-label="Controles e información">
          <div>
            <h1 class="title">Stage 5 — Interactivo</h1>
            <p class="desc">
              Modelo optimizado para web. Compatible con AR en dispositivos
              modernos. Experiencia móvil mejorada: overlay de reproducción,
              controles táctiles grandes y diseño adaptativo.
            </p>
            <p class="hint">
              Consejo: en iOS activa sonido desde el centro de control si el
              autoplay falla.
            </p>
          </div>

          <div class="meta">
            <div class="box">
              <div class="small">Formato</div>
              <div class="val">GLB (binary)</div>
            </div>
            <div class="box">
              <div class="small">Tamaño</div>
              <div class="val">~2.4 MB</div>
            </div>
          </div>

          <div class="controls">
            <button id="resetCam" class="btn" title="Reset cámara">
              Reset
            </button>
            <button id="fitModel" class="btn" title="Ajustar a vista">
              Fit
            </button>
            <button
              id="toAR"
              class="btn"
              title="Ir a AR"
              onclick="location.href='https://alejmmtz.github.io/deadmau5-dancing-model23jcxt/'"
            >
              Abrir AR
            </button>
            <button
              id="downloadBtn"
              class="btn primary"
              title="Descargar glTF"
              style="margin-left: auto"
            >
              Descargar
            </button>
          </div>
        </aside>
      </main>
    </div>

    <script
      type="module"
      src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"
    ></script>

    <script>
      // referencias DOM
      const bgAudio = document.getElementById("bgAudio");
      const muteToggle = document.getElementById("muteToggle");
      const overlay = document.getElementById("overlayPlay");
      const overlayBtn = document.getElementById("overlayPlayBtn");
      const arQuick = document.getElementById("arQuick");
      const mv = document.getElementById("mv");
      const downloadBtn = document.getElementById("downloadBtn");

      // mejoras para iOS Safari
      try {
        bgAudio.setAttribute("playsinline", "");
        bgAudio.setAttribute("webkit-playsinline", "");
        bgAudio.webkitPlaysInline = true;
      } catch (e) {}

      // start logic: robust autoplay strategy
      async function tryAutoplay() {
        // si ya está sonando, nada que hacer
        if (!bgAudio) return false;
        try {
          // preferimos sin mute si es posible
          bgAudio.muted = false;
          await bgAudio.play();
          onAudioPlaySuccess();
          return true;
        } catch (err) {
          // intento con muted first
          try {
            bgAudio.muted = true;
            await bgAudio.play();
            // algunos navegadores permiten desmutear después de un timeout
            setTimeout(() => {
              try {
                bgAudio.muted = false;
              } catch (e) {}
            }, 250);
            onAudioPlaySuccess();
            return true;
          } catch (err2) {
            // autoplay completamente bloqueado
            showOverlay(true);
            return false;
          }
        }
      }

      function onAudioPlaySuccess() {
        showOverlay(false);
        updateMuteButton(!bgAudio.muted);
      }

      function showOverlay(visible) {
        overlay.style.display = visible ? "block" : "none";
      }

      // inicializar
      window.addEventListener("load", () => {
        tryAutoplay();
      });

      // si hay interacción del usuario (touch o click) intentamos reproducir otra vez
      ["touchstart", "click"].forEach((ev) => {
        window.addEventListener(
          ev,
          async function one() {
            await tryAutoplay();
            window.removeEventListener(ev, one);
          },
          { passive: true }
        );
      });

      // overlay button (móvil) para lanzar reproducción
      overlayBtn &&
        overlayBtn.addEventListener("click", async () => {
          try {
            await bgAudio.play();
            bgAudio.muted = false;
            showOverlay(false);
            updateMuteButton(false);
          } catch (e) {
            console.warn("play error", e);
          }
        });

      // toggle mute
      function updateMuteButton(isMuted) {
        muteToggle.setAttribute("aria-pressed", String(!isMuted));
        const svg = document.getElementById("muteSvg");
        if (isMuted) {
          // show muted icon (with X)
          svg.innerHTML =
            '<path d="M5 9v6h4l5 4V5L9 9H5z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M17 7l4 4m0-4l-4 4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>';
        } else {
          // show sound waves
          svg.innerHTML =
            '<path d="M5 9v6h4l5 4V5L9 9H5z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M19 9a7 7 0 0 1 0 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>';
        }
      }

      muteToggle.addEventListener("click", async () => {
        // si no ha empezado a reproducir, intenta arrancar
        if (bgAudio.paused)
          try {
            await bgAudio.play();
          } catch (e) {}
        bgAudio.muted = !bgAudio.muted;
        updateMuteButton(bgAudio.muted);
      });

      // quick AR click proxies to model-viewer AR button when available
      arQuick &&
        arQuick.addEventListener("click", () => {
          const arBtn = document.getElementById("ar-button");
          if (arBtn) arBtn.click();
        });

      // camera controls
      document.getElementById("resetCam").addEventListener("click", () => {
        mv.cameraOrbit = "-270.3deg 87.17deg 258.5m";
        mv.jumpCameraToGoal();
      });
      document.getElementById("fitModel").addEventListener("click", () => {
        mv.fitCameraToModel();
      });

      // download (simple link to model file) — sustituye según tu configuración de servidor
      downloadBtn.addEventListener("click", () => {
        const a = document.createElement("a");
        a.href = "stage5.glb";
        a.download = "stage5.glb";
        document.body.appendChild(a);
        a.click();
        a.remove();
      });

      // UX: detect if on small screen to show overlay play prominenly
      function isSmall() {
        return window.matchMedia("(max-width:520px)").matches;
      }
      if (isSmall()) showOverlay(true);

      // mantener preferencia del usuario en localStorage (mute)
      try {
        const saved = localStorage.getItem("bgAudioMuted");
        if (saved !== null) {
          bgAudio.muted = saved === "true";
        }
      } catch (e) {}
      // guardar al cambiar
      bgAudio.addEventListener("volumechange", () => {
        try {
          localStorage.setItem("bgAudioMuted", String(bgAudio.muted));
        } catch (e) {}
      });
    </script>
  </body>
</html>
